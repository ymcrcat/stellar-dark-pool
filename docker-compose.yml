services:
  matching-engine:
    build:
      context: ./matching-engine
      dockerfile: Dockerfile
      platforms: 
        - linux/amd64
        - linux/arm64
    image: stellar-darkpool-matching-engine:latest
    container_name: stellar-darkpool-matching-engine
    ports:
      - "${REST_PORT:-8080}:${REST_PORT:-8080}"
    environment:
      # Stellar Network Configuration
      STELLAR_NETWORK_PASSPHRASE: ${STELLAR_NETWORK_PASSPHRASE:-Test SDF Network ; September 2015}
      SOROBAN_RPC_URL: ${SOROBAN_RPC_URL:-https://soroban-testnet.stellar.org}

      # Settlement Contract Configuration
      SETTLEMENT_CONTRACT_ID: ${SETTLEMENT_CONTRACT_ID}

      # Matching Engine Signing Configuration
      # Note: MATCHING_ENGINE_SIGNING_KEY is automatically generated in the container
      # at startup and is ephemeral (regenerated on each restart)

      # Server Configuration
      REST_PORT: ${REST_PORT:-8080}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request, os; port = os.getenv('REST_PORT', '8080'); urllib.request.urlopen(f'http://localhost:{port}/health').read()"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - darkpool-network

networks:
  darkpool-network:
    driver: bridge
